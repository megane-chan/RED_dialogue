---
title: "REM"
output: 
  pdf_document:
    
    toc: false
    toc_depth: 4
    number_sections: false
    fig_caption: true
    keep_tex: true
    latex_engine: xelatex
editor_options:
y  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}

rm(list=ls())
setwd("~/RProjects/SNA_REM/REM_new/")
library(tidyr)
library(caret)
library(network)
library(relevent)
library(survival)
library(rem)
library(dplyr)
library(ggplot2)
library(igraph)
library(ggraph)
library(RColorBrewer)
library(tidyr)
knitr::opts_chunk$set(fig.align='center', fig.width=8, fig.height=6, options(tidy = TRUE), tidy.opts = list(width.cutoff = 60))

```

## Interactions and Actors Data

Interactions between the team members for high-performance sessions:

-   sender

-   receiver

-   time of the interaction

-   type of interaction (dialogue act type)

Actors Data:

-   name

-   gender

```{r}
# Interactions Data Frame (Edges)
high_perf_interactions <- readRDS("data/high_performance_sessions.RData") %>% 
  select(session, sender_id, receiver_id, dialog, time)


interactions <- high_perf_interactions %>%
  mutate(
    sender_id = as.integer(sender_id),  
    receiver_id = as.integer(receiver_id), 
    dialog = as.factor(dialog) 
  )



actors_attributes <- data.frame(
  id = 1:8,
  name = c("Igor", "Ashley", "Will", "Katya", "Saleh", "Oleg", "Vika", "Alex"),
  gender = c("male", "female", "male", "female", "male", "male", "female", "male")
)

# Create dummy variables for gender
dummyvars <- dummyVars(" ~ gender", data = actors_attributes)
actors_attributes <- cbind(actors_attributes, predict(dummyvars, actors_attributes)) %>%
  select(id, name, gendermale)
```

## Summary by Session and Speaker

```{r}

session_dialogues <- high_perf_interactions %>%
  group_by(session) %>%
  summarise(n = n())


ggplot(session_dialogues, aes(x = factor(session), y = n, fill = factor(session))) + 
  geom_bar(stat = "identity") +
  scale_fill_brewer(palette = "Pastel1") +  
  labs(title = "Number of Dialogues Per Session (High Performance)",
       x = "Session",
       y = "Number of Dialogues",
       fill = "Session") +
  theme_minimal() + 
  theme(legend.position = "none") 

```

```{r}

dialogues_per_speaker_session <- high_perf_interactions %>%
  left_join(actors_attributes, by = c("sender_id" = "id")) %>%
  group_by(session, name) %>%
  summarise(number_of_dialogues = n(), .groups = 'drop') %>%
  arrange(session, desc(number_of_dialogues))

dialogues_summary_tibble <- as_tibble(dialogues_per_speaker_session)
print(dialogues_summary_tibble)


ggplot(dialogues_summary_tibble, aes(x = name, y = number_of_dialogues, fill = name)) + 
  geom_bar(stat = "identity") +
  facet_wrap(~session) +
  scale_fill_brewer(palette = "Pastel1") +  
  labs(subtitle = "Number of Dialogues Per Speaker Per Session (High Performance)",
       x = "Speaker",
       y = "Number of Dialogues",
       fill = "Speaker") +
  theme_minimal() + 
  theme(legend.position = "none") 

```

```{r}
target_session <- 2104

high_perf_interactions %>% filter(receiver_id != 0) %>% filter(session == target_session) %>% select(-session) %>% mutate(time = 1:nrow(.))  %>% select(sender_id, receiver_id, time,dialog)  %>% mutate(dialog = as.factor(dialog), sender_id = as.integer(sender_id), receiver_id = as.integer(receiver_id)) -> interactions

actors_attributes %>% filter(id %in% interactions$sender_id) %>% filter(id %in% interactions$receiver_id) -> actors_attributes
head(actors_attributes)


g_subset <- graph_from_data_frame(interactions, directed = TRUE, vertices = data.frame(actors_attributes))


V(g_subset)$gender <- actors_attributes$gender[match(V(g_subset)$name, actors_attributes$name)]
V(g_subset)$name <- actors_attributes$name[match(V(g_subset)$name, actors_attributes$name)]

```

#### Dialogue Flow Illustration

```{r}
dialog_colors <- RColorBrewer::brewer.pal(n = length(unique(interactions$dialog)), name = "Pastel2")
dialog_color_map <- setNames(dialog_colors, unique(interactions$dialog))


ggraph(g_subset, layout = 'fr') +
  geom_edge_link(aes(color = dialog), alpha = 0.7, edge_width = .2, lineend = "butt", arrow = arrow(type = 'closed', length = unit(4, 'mm'))) +
  scale_edge_color_manual(values = dialog_color_map) +
  geom_node_point(aes(color = factor(gender)), size = 4, alpha = 0.8) +
  geom_node_text(aes(label = name), repel = TRUE,  color = "black", size = 3, vjust = 1, nudge_x = -.02) +
  scale_color_manual(values = c('0' = 'red', '1' = 'cyan')) +
  theme_void() +
  labs(subtitle = "High Performing Session 2104", color = "Gender", edge_color = "Dialog") +
  theme(legend.position = "right", legend.title = element_text(size = 8))
```

#### Degree Distribution

```{r}

degree_stats <- degree(g_subset, mode = "all")  

betweenness_stats <- betweenness(g_subset, directed = TRUE)

network_stats_summary <- data.frame(
  name = V(g_subset)$name,
  degree = degree_stats
)


print(network_stats_summary)


influencers <- network_stats_summary %>%
  arrange(desc(degree)) %>%
  head(3) 
print(influencers)
```

-   **Degree**: This is the number of direct connections a node has.

    -   Ashley has the highest degree (473), or the greatest direct connections in the network.

-   **Closeness**: This measures how quickly a node can access all other nodes in the network. Higher values represent shorter paths to all other nodes.

    -   Ashley, with a closeness of 1.0000000, is the quickest to reach all other nodes.

Check for Isolates, Connectivity, and Directionality

```{r}

isolates <- which(degree(g_subset) == 0)
if (length(isolates) > 0) {
  print(V(g_subset)$name[isolates])
}


is.fully.connected <- is_connected(g_subset)
print(is.fully.connected)


is.directed <- is_directed(g_subset)
print(is.directed)

```

```{r}
in_degree_stats <- degree(g_subset, mode = "in")
out_degree_stats <- degree(g_subset, mode = "out")
total_degree_stats <- in_degree_stats + out_degree_stats
rbind(in_degree_stats, out_degree_stats, total_degree_stats)

```

# REM Analysis

```{r, eval=FALSE}
interactions$time<-as.numeric(interactions$time) 

# Create the REM data set
REM.data <- createRemDataset(
  data = interactions, 
  sender = interactions$sender_id,
  target = interactions$receiver_id,
  eventSequence = interactions$time,
  eventAttribute = interactions$dialog,
  atEventTimesOnly = TRUE, 
  untilEventOccurrs = TRUE,
  includeAllPossibleEvents = FALSE, 
  returnInputData = FALSE
)

#save as RDS
#saveRDS(REM.data, "data/REM_data_onlyevent.RDS")

```

```{r, eval=TRUE}
readRDS("data/REM_data.RDS") -> REM.data
```

```{r}
# Check the structure of the REM.data
str(REM.data)
```

```{r}
head(REM.data)
```

```{r}

surv_object <- Surv(time = REM.data$eventTime, event = REM.data$eventDummy)


cox_model <- coxph(surv_object ~ sender + target, data = REM.data)


summary(cox_model)

```

```{r}

model2_event <- coxph(surv_object ~ eventAttribute, data = REM.data)
summary(model2_event)
```

```{r}

model3_snd_event <- coxph(surv_object ~ sender + eventAttribute, data = REM.data)
summary(model3_snd_event)
```

-   The `Concordance` statistic is a measure of the model's predictive ability, with 0.5 indicating no predictive ability and 1 indicating perfect prediction.

### Survival Analysis

-   How different factors (like senders, targets, event attributes) affect the likelihood of events:

-   `coef` in the model indicate the *logarithmic* change in hazard rates for different categories compared to a *baseline*. A positive coefficient indicates an increased hazard (or risk) of the event occurring when the variable increases, while a negative coefficient indicates a decreased hazard.

-   `exp(coef)` represents the *hazard ratio*, which explains the effect size. values greater than 1 indicate an increased hazard, values less than 1 indicate a decreased hazard.

-   The p-values (`Pr(>|z|)`) help determine the significance of the predictors.

## Result Analysis:

**Model 1: `sender` + `target`** as predictors

predictors are the sender and target IDs of the events.

-   **Senders 3, 4, 5, 6, and 7** have significant negative coefficients, suggesting that events sent by these individuals are less likely to occur compared to the baseline.
-   **Target 3 and 6** have significant negative coefficients, indicating events targeting these individuals are less likely to occur than the baseline target.
-   The p-values for the above mentioned actors are all below 0.05.
-   The overall model shows good predictive power with a concordance index of 0.606.

**Model 2: `eventAttribute`** as predictors

-   **`question` and `statement` types of dialog** have a positive and significant effect on the hazard, indicating these types of events are more likely to occur. Their coefficients are positive with low p-values (\< 2e-16 for `statement`, 4.63e-07 for `question`), showing strong evidence for their influence.
-   The `disruption` and `floor-grabber` types do not show a significant effect since their p-values are above 0.05.
-   The model has a concordance index of 0.641, indicating a reasonably good fit.

**Model 3: `sender` + `eventAttribute`** - senders and dialog types as predictors.

-   Similar to Model 1, **senders 3, 4, 5, 6, and 7** are significant predictors with negative coefficients, meaning events from these senders are less likely to happen compared to the reference sender.
-   As in Model 2, **`question` and `statement`** types of dialog are significant with positive coefficients, which means these event types are more likely to occur.
-   The coefficients for `disruption` and `floor-grabber` are not significant in this model as well
-   The concordance index is 0.665, the **highest** among the three models, suggesting this model has the best predictive ability.

### Summary

-   **Sender Effect**: Negative coefficients for all senders indicate they all decrease the event's hazard compared to a baseline, with `sender5` showing a significant reduction.
-   **Target Effect**: Similarly, most targets also reduce hazard rates, except `target4` and `target7` where the effect is not significant.
-   **Event Attributes** significantly increases the hazard of an event occurring.
    -   The `eventAttribute` variables have significant coefficients for `question` and `statement`, indicating that these attributes are associated with the occurrence of events.
    -   The hazard ratio of `statement` is about 4.41, suggesting its strong association with the occurrence of events...Is the effect of "statement" on event occurrences is genuinely significant, or is it inflated by the volume?
    -   `question` turns out to be important!
