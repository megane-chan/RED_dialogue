---
output:
pdf_document: default
html_document: default
---
```{r, message = FALSE, include = FALSE}
# Last Updated: 02/12
rm(list = ls())

# Load libraries
library(rstudioapi)
library(tidyverse)
library(tidyr)
library(ggplot2)
library(dplyr)

library(RColorBrewer)
library(dplyr)
library(igraph)
library(readxl)
library(igraph)
library(glmnet)
library(remsonic)
library(skimr)
library(dplyr)
library(relevent)
# Set Path
setwd("~/RProjects/SNA_REM/REM_new/")
```

# Session 2103
```{r}
# read excel
dialog_data <- read_excel("data/nek21.xlsx", sheet = "Sheet1_Dialogs")
head(dialog_data)
```

All   Igor Ashley   Will  Katya  Saleh   Oleg   Vika   Alex
0      1      2      3      4      5      6      7      8

```{r}
people_list <- unique(dialog_data$sender)
# if the sender is All, make ID is 0
people_list <- people_list[people_list != "All"]
lookup_table <- setNames(seq_along(people_list), people_list)
# add All to the lookup table with ID 0
lookup_table <- c(All = 0, lookup_table)
print(lookup_table)
```


```{r}
dialog_data[, 'sender_id'] <- lookup_table[dialog_data$sender]
dialog_data[, 'receiver_id'] <- lookup_table[dialog_data$receiver]
head(dialog_data)
```

# for event order, add 1 to make it start from 1  and icnreasing by 1 (row number)
df_high2105[,'event_order'] <- seq(1, nrow(df_high2105))
head(df_high2105)


```{r}
perf_data <- read_excel("data/nek21.xlsx", sheet = "Sheet2_Perfs")
head(perf_data)
```


```{r}
# find all sessionsi of where perf_level is low, high, fail respectively
low_perf <- perf_data %>% filter(perf_level == "low")
high_perf <- perf_data %>% filter(perf_level == "high")
fail_perf <- perf_data %>% filter(perf_level == "fail")
print(paste("Number of low performance sessions: ", nrow(low_perf), list(low_perf$session)))
print(paste("Number of high performance sessions: ", nrow(high_perf), list(high_perf$session)))
print(paste("Number of fail performance sessions: ", nrow(fail_perf), list(fail_perf$session)))
```

```{r}
print("High performance sessions")

# get the high performance session 2104, 2105, 2112, 2113, 2114, 2118
for (s in high_perf$session) {
  print(paste("Session: ", s))
  # for each session, add numbers 1 to the total row numbers representing the event order
  session_data <- dialog_data %>% filter(session == s)
  session_data <- session_data %>% mutate(event_order = seq(1, nrow(session_data)))
  assign(paste("df_high_", s, sep = ""), session_data)
}


print("Low performance sessions")
for (s in low_perf$session) {
  print(paste("Session: ", s))
  session_data <- dialog_data %>% filter(session == s)
  session_data <- session_data %>% mutate(event_order = seq(1, nrow(session_data)))
  assign(paste("df_low_", s, sep = ""), session_data)
}

# fail
print("Failed sessions")
for (s in fail_perf$session) {
  print(paste("Session: ", s))
  ession_data <- dialog_data %>% filter(session == s)
  session_data <- session_data %>% mutate(event_order = seq(1, nrow(session_data)))
  assign(paste("df_fail_", s, sep = ""), session_data)
}
```

# high performance session 2105


```{r}

session_data <- df_high_2104 %>%
  as.data.frame() %>%
  select(event_order, sender_id, receiver_id)


# Calculate statistics for the REM
stats.intercept <- Constant(session_data)
stats.rrecsnd <- RRecSnd(session_data)
stats.rsndsnd <- RSndSnd(session_data)

# Combine statistics
stats1 <- combine.stats(
  '[Intercept]' = stats.intercept,
  'RRecSnd' = stats.rrecsnd,
  'RSndSnd' = stats.rsndsnd
)

# Fit the first REM model
model1 <- FitEventNetworkCore(session_data, stats1)
summary(model1)

```


```{r}

# Model 2 -----------------------------------------------------------------

session_data <- session_data.frame(sid = df_high2105$sender_id, rid = df_high2105$receiver_id, time = df_high2105$event_order, sender_dialog = df_high2105$sender_dialog)

# Adding the second term: the Normalized Total Degree Received (NTDRec)
stats.ntdegrec <- NTDRec(session_data)
stats2 <- combine.stats(
  '[Intercept]' <- stats.intercept,
  'RRecSnd' = stats.rrecsnd,
  'RSndSnd' = stats.rsndsnd,
  'NTDegRec' = stats.ntdegrec
)

# Run the second model and check the transript_session_data
model2 <- FitEventNetworkCore(session_data, stats2, ordinal = FALSE)
summary(model2)
```


```{r}

# add a column representing if the sender and receiver are of the same gender
same_gender <- ifelse(df_high2105$sender_gender == df_high2105$receiver_gender, 1, 0)
session_data <- session_data.frame(sid = df_high2105$sender_id, rid = df_high2105$receiver_id, time = df_high2105$event_order, sender_dialog = df_high2105$sender_dialog)

# Model 3 -----------------------------------------------------------------

stats.sameGender <- SameConstGroup(session_data, same_gender)

stats3 <- combine.stats(
  '[Intercept]' = stats.intercept,
  'RRecSnd' = stats.rrecsnd,
  'RSndSnd' = stats.rsndsnd,
  'NTDegRec' = stats.ntdegrec,
  'SameConstGroup' = stats.sameGender
)

# Run the third model and check the transript_session_data
model3 <- FitEventNetworkCore(session_data, stats3, ordinal = FALSE)
summary(model3)
```



