---
title: "REM"
output: 
  pdf_document:
    
    toc: false
    toc_depth: 4
    number_sections: false
    fig_caption: true
    keep_tex: true
    latex_engine: xelatex
editor_options:
y  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}

rm(list=ls())
setwd("~/RProjects/SNA_REM/REM_new/")
library(tidyr)
library(caret)
library(network)
library(relevent)
library(kableExtra)
library(survival)
library(rem)
library(dplyr)
library(ggplot2)
library(igraph)
library(ggraph)
library(RColorBrewer)
library(tidyr)
knitr::opts_chunk$set(fig.align='center', fig.width=8, fig.height=6, options(tidy = TRUE), tidy.opts = list(width.cutoff = 60))

```

## Interactions and Actors Data

Interactions between the team members for high-performance sessions:

-   sender

-   receiver

-   time of the interaction

-   type of interaction (dialogue act type)

Actors Data:

-   name

-   gender

```{r}
# Interactions Data Frame (Edges)

high_perf_interactions <- readRDS("data/high_performance_sessions.RData") %>% 
  select(session, sender_id, receiver_id, dialog, time) %>% mutate(performance = "high")
low_perf_interactions <- readRDS("data/low_performance_sessions.RData") %>% filter(session != 2102) %>%
  select(session, sender_id, receiver_id, dialog, time) %>% mutate(performance = "low")

all_sessions <- rbind(high_perf_interactions, low_perf_interactions) %>%
  mutate(
    sender_id = as.integer(sender_id),  
    receiver_id = as.integer(receiver_id), 
    dialog = as.factor(dialog),
    performance = as.factor(performance)
  )

dim(all_sessions)
```


```{r}
head(all_sessions) %>% kable("html") %>% kable_styling("striped", full_width = F)
```

```{r}
actors_attributes <- data.frame(
  id = 1:7,
  name = c("Igor", "Ashley", "Will", "Katya", "Saleh", "Oleg", "Vika"),
  gender = c("male", "female", "male", "female", "male", "male", "female")
)

# join snder and receiver attributes add two new colomns senger   and receiver gender
all_sessions %>% left_join(actors_attributes, by = c("sender_id" = "id")) %>% left_join(actors_attributes, by = c("receiver_id" = "id"))  %>% rename(sender = name.x, receiver = name.y) %>% rename(sender_gender = gender.x, receiver_gender = gender.y)-> all_sessions
head(all_sessions) %>% kable("html") %>% kable_styling("striped", full_width = F)


# vsace high rds
#saveRDS(all_sessions, "data/final_all_sessions.RDS")
```

```{r}
```

```{r}
```

```{r}

actors_attributes  %>% as.data.frame() %>% kable("html") %>% kable_styling("striped", full_width = F)
# Create dummy variables for gender
dummyvars <- dummyVars(" ~ gender", data = actors_attributes,dropFirst = TRUE)
actors_attributes <- cbind(actors_attributes, predict(dummyvars, actors_attributes)) %>%
  select(id, name, gendermale)


```

## Summary by Session and Speaker


```{r}
unique(all_sessions$session)
```
```{r}

# Number of dialogues per session by team performance
all_sessions %>% group_by(session, performance) %>% summarise(n = n(), .groups = 'drop') -> session_dialogues
ggplot(session_dialogues, aes(x = session, y = n, fill = factor(performance))) + 
  geom_bar(stat = "identity") +
  scale_fill_brewer(palette = "Pastel1") +  
  geom_text(aes(label = n), vjust = -0.5, size = 3) +
  geom_text(aes(label = session), y = -45, vjust = -.5, angle = 45, size = 3) +
  # enlarge the plot area
  theme(plot.margin = margin(1, 1, 1, 1, "cm")) +
  theme(legend.position = "none") +
  theme_graph(base_family = "Times", caption_size = 12, base_size = 11, plot_margin = margin(4,2,6,2)) +
  # no xtick
  theme(axis.text.x = element_blank()) +
  labs(caption = "Total Number of Dialogues Per Session by Team Performance",
       x = "",
       y = "Number of Dialogues",
       fill = "Performance") 
ggsave("image/dialogues_by_session_wo_2103.png", width = 8, height = 6)
```

```{r}
# take away 2103
all_sessions %>% filter(session != 2103) -> session_dialogues

# Number of dialogues per session by team performance
session_dialogues %>% group_by(session, performance) %>% summarise(n = n(), .groups = 'drop') -> session_dialogues
ggplot(session_dialogues, aes(x = session, y = n, fill = factor(performance))) + 
  geom_bar(stat = "identity") +
  scale_fill_brewer(palette = "Pastel1") +  
  geom_text(aes(label = n), vjust = -0.5, size = 3) +
  geom_text(aes(label = session), y = -45, vjust = -.5, angle = 45, size = 3) +
  # enlarge the plot area
  theme(plot.margin = margin(1, 1, 1, 1, "cm")) +
  theme(legend.position = "none") +
  theme_graph(base_family = "Times", caption_size = 12, base_size = 11, plot_margin = margin(4,2,6,2)) +
  # no xtick
  theme(axis.text.x = element_blank()) +
  labs(caption = "Total Number of Dialogues Per Session by Team Performance",
       x = "",
       y = "Number of Dialogues",
       fill = "Performance") 
ggsave("image/dialogues_by_session_wo_2103.png", width = 8, height = 6)
```

```{r}
all_sessions %>% filter(sender_id %in% actors_attributes$id) %>% filter(receiver_id %in% actors_attributes$id) -> all_sessions
dialogues_per_speaker<- all_sessions %>%
  left_join(actors_attributes, by = c("sender_id" = "id")) %>%
  group_by( name) %>%
  summarise(number_of_dialogues = n(), .groups = 'drop') %>%
  arrange(desc(number_of_dialogues))

# plot
ggplot(dialogues_per_speaker, aes(x = name, y = number_of_dialogues)) + 
  geom_bar(stat = "identity", fill = "lightblue") +  #
  labs(caption = "Total Number of Dialogues By Speaker (Across All Sessions)",
       x = "",
       y = "Number of Dialogues") +
  # do not use grey for color of bars
  theme_graph(base_family = "Times", caption_size = 11, base_size = 11, plot_margin = margin(4,2,4,2)) +
  # label number
  geom_text(aes(label = number_of_dialogues), vjust = -0.5, size = 3.5) +
  theme(axis.text.x = element_text(size = 11, angle = 45, hjust = 1)) 
#ggsave("image/dialogues_per_speaker.png", width = 8, height = 6)
```


```{r}
# Number of Dialogues Across in high and low performance sessions
par(mfrow=c(1,2))
dialogues_per_speaker <- all_sessions %>%
  left_join(actors_attributes, by = c("sender_id" = "id")) %>%
  group_by(name, session,performance) %>%
  summarise(number_of_dialogues = n(), .groups = 'drop') %>%
  arrange(desc(number_of_dialogues))

# for (s in unique(dialogues_per_speaker$session)) {
#  dialogues_per_speaker  %>% filter(session == s) -> dialogues_per_speaker_by_session 
#  print(kable(dialogues_per_speaker_by_session) %>% kable_styling("striped", full_width = F))

#}
```

```{r}
# number of dialogues by dialogu type across all sessions
dialogues_per_dialogue <- all_sessions %>%
  group_by(dialog) %>%
  summarise(number_of_dialogues = n(), .groups = 'drop') %>%
  arrange(desc(number_of_dialogues))

ggplot(dialogues_per_dialogue, aes(x = dialog, y = number_of_dialogues)) + 
   geom_bar(stat = "identity", fill = "lightblue") +  #
  labs(caption = "Number of Dialogues By Dialogue Type (Across All Sessions)",
       x = "Dialogue Type",
       y = "Number of Dialogues") +  
   geom_text(aes(label = dialog), y = -45, vjust = 2, angle = 0, size = 3) +
 theme_graph(base_family = "Times", caption_size = 12, base_size = 11, plot_margin = margin(4,2,6,2)) +
  geom_text(aes(label = number_of_dialogues), vjust = -0.5, size = 3) +
  theme(legend.position = "none")
```


```{r}
# by dialogues by gebder
total_dialogues_by_gender <- all_sessions %>%
  left_join(actors_attributes, by = c("sender_id" = "id")) %>%
  group_by(gendermale, session, performance) %>% #
  summarise(number_of_dialogues = n(), .groups = 'drop') %>%
  arrange(desc(number_of_dialogues))
total_dialogues_by_gender$gendermale <- factor(total_dialogues_by_gender$gendermale)

ggplot(total_dialogues_by_gender) +
  geom_bar(aes(x = session, y = number_of_dialogues, fill = gendermale, color = performance), stat = "identity") +
  scale_fill_manual(values = c("lavender", "lightblue")) +
  theme_graph(base_family = "Times", caption_size = 12, base_size = 12, plot_margin = margin(2,2,2,2)) +
  # add session id to the plot
  geom_text(aes(x = session, label = session), y = -50, vjust = 1, size = 3) +
  labs(caption = "Number of Dialogues By Gender and Session-Performance")
```


```{r}
total_dialogues_by_gender <- all_sessions %>%
  left_join(actors_attributes, by = c("sender_id" = "id")) %>%
  group_by(gendermale, performance) %>% #
  summarise(number_of_dialogues = n(), .groups = 'drop') %>%
  arrange(desc(number_of_dialogues))
total_dialogues_by_gender$gendermale <- factor(total_dialogues_by_gender$gendermale)

ggplot(total_dialogues_by_gender) +
  geom_bar(aes(x = performance, y = number_of_dialogues, fill = gendermale), stat = "identity") +
  scale_fill_manual(values = c("lavender", "lightblue")) +
  scale_x_discrete(labels = c("high" = "High Performance", "low" = "Low Performance")) +
  theme_graph(background = "white", base_family = "Times", caption_size = 12, base_size = 12, plot_margin = margin(4,2,6,2))+
  theme(axis.text.x = element_text(size = 12)) +
  labs(caption = "Number of Dialogues By Gender and Performance")
```
```{r}
total_dialogues_by_gender <- all_sessions %>%
  left_join(actors_attributes, by = c("sender_id" = "id")) %>%
  group_by(gendermale, dialog) %>% #
  summarise(number_of_dialogues = n(), .groups = 'drop') %>%
  arrange(desc(number_of_dialogues))
total_dialogues_by_gender$gendermale <- factor(total_dialogues_by_gender$gendermale)

ggplot(total_dialogues_by_gender) +
  geom_bar(aes(x = dialog, y = number_of_dialogues, fill = gendermale), stat = "identity") +
  scale_fill_manual(values = c("lavender", "lightblue")) +
  # backchannel disruption floor-grabber question statement
  scale_x_discrete(labels = c("backchannel" = "Backchannel", "disruption" = "Disruption", "floor-grabber" = "Floor-Grabber", "question" = "Question", "statement" = "Statement")) +
  theme_graph(base_family = "Times", caption_size = 12, base_size = 12, plot_margin = margin(4,2,6,2)) +
  theme(axis.text.x = element_text(size = 12)) +
  labs(caption = "Number of Dialogues By Gender and Dialogue Act Type")
```

```{r}
dialogues_per_speaker_session <- all_sessions %>%
  left_join(actors_attributes, by = c("sender_id" = "id")) %>%
  group_by(session, name) %>%
  summarise(number_of_dialogues = n(), .groups = 'drop') %>%
  arrange(session, desc(number_of_dialogues))

dialogues_summary_tibble <- as_tibble(dialogues_per_speaker_session)
print(dialogues_summary_tibble)


ggplot(dialogues_summary_tibble, aes(x = name, y = number_of_dialogues, fill = name)) + 
  geom_bar(stat = "identity") +
  facet_wrap(~session) +
  scale_fill_brewer(palette = "Pastel1") +  
  labs(subtitle = "Number of Dialogues Per Speaker Per Session",
       x = "Speaker",
       y = "Number of Dialogues",
       fill = "Speaker") +
 theme_graph(base_family = "Times", caption_size = 11, base_size = 12, plot_margin = margin(4,2,2,2)) +
  geom_text(aes(label = number_of_dialogues), vjust = -0.5, size = 2.5) + theme(element_blank()) 
```

```{r}

dialogues_per_speaker_session <- all_sessions %>%
  left_join(actors_attributes, by = c("sender_id" = "id")) %>%
  group_by(session, name, performance) %>%
  summarise(number_of_dialogues = n(), .groups = 'drop') %>%
  arrange(session, desc(number_of_dialogues))

dialogues_summary_tibble <- as_tibble(dialogues_per_speaker_session)
print(dialogues_summary_tibble)

# take away katya and session 2103
dialogues_summary_tibble %>% filter(name != "Katya") %>% filter(session != 2103) -> dialogues_summary_tibble

ggplot(dialogues_summary_tibble, aes(x = name, y = number_of_dialogues, fill = name)) + 
  geom_bar(stat = "identity") +
  facet_wrap(~session) +
  #  use different colors for high and low respectively
  scale_fill_brewer(palette = "Pastel1") +
  labs(subtitle = "Number of Dialogues By Speaker and Session",
       x = "Speaker",
       y = "Number of Dialogues",
       fill = "Speaker") +
 theme_graph(base_family = "Times", caption_size = 11, base_size = 12, plot_margin = margin(4,2,2,2)) +
  geom_text(aes(label = number_of_dialogues), vjust = -0.5, size = 2.5) + theme(element_blank()) 

```

```{r}

all_sessions <-readRDS("data/final_all_sessions.RDS")
interactions <- all_sessions %>% select(sender_id, receiver_id, dialog, time)
```

```{r}

# if sender_sender == receiver_gender it is same gender
interactions$same_gender <- ifelse(actors_attributes$gendermale[match(interactions$sender_id, actors_attributes$id)] == actors_attributes$gendermale[match(interactions$receiver_id, actors_attributes$id)], 1, 0)
# same gender as edge
interactions

```

```{r}
g <- graph_from_data_frame(interactions, directed = TRUE)

V(g)$name <- actors_attributes$name[match(V(g), actors_attributes$id)]
V(g)$node_id <- actors_attributes$id[match(V(g)$name, actors_attributes$name)] 
V(g)$gender <- actors_attributes$gender[match(V(g), actors_attributes$id)] %>% as.factor()
E(g)$dialog <- interactions$dialog
E(g)$time <- interactions$time
E(g)$same_gender <- ifelse(actors_attributes$gender[match(interactions$sender_id, actors_attributes$id)] == actors_attributes$gender[match(interactions$receiver_id, actors_attributes$id)], 1,0)
```


```{r}

# Assuming `g` is your igraph object representing the network
# and it has a `gender` attribute in nodes to distinguish male and female participants

# Define a color palette for gender
gender_colors <- c("male" = "blue", "female" = "pink")

# Plotting the graph using ggraph
ggraph(g, layout = 'fr') + 
  geom_node_point(aes(color = gender), size = 5) + 
  geom_node_text(aes(label = name), repel = TRUE) +
  # reflect edge direction
  geom_edge_link(aes(color = dialog), alpha = 0.6, end_cap = circle(3, 'mm')) +
  scale_color_manual(values = gender_colors) + # Use the color palette for gender
  labs(title = "Network Graph of Dialogue Types Among Participants Highlighted by Gender",
       color = "Gender") +
  theme_void() + # Simplify the plot theme
  theme(legend.position = "right") # Adjust the legend position
```

```{r}
par(mfrow=c(1,1), mar=c(1,1,1,1))
palette <- brewer.pal(8, "Pastel2") 
pal2 <- brewer.pal(8, "Set3")
gender_unique <- unique(V(g)$gender)
dialog_unique <- unique(E(g)$dialog)
dialog_col <- setNames(palette[1:length(dialog_unique)], dialog_unique)
gender_col <- setNames(pal2[1:length(gender_unique)],gender_unique)
plot(g, edge.color = dialog_col[E(g)$dialog], edge.width = .8, vertex.color = gender_col[V(g)$gender], vertex.size = 25, vertex.label.cex = 0.8, vertex.label.color = "black", edge.arrow.size = 0.5, edge.curved = 0.1, main = "", sub = "Nodes represent actors, edges represent interactions", cex.main = 1, cex.sub = 0.8)
legend("topleft", legend = c("Backchannel", "Disruption", "Floor-Grabber", "Question", "Statement"), fill = dialog_col, title = "Dialogue Type", cex = 0.8)
```





#### Dialogue Flow Illustration

```{r}
dialog_colors <- RColorBrewer::brewer.pal(n = length(unique(all_sessions$dialog)), name = "Pastel2")
dialog_color_map <- setNames(dialog_colors, unique(all_sessions$dialog))
# for each session plot 1 graph

unique(all_sessions$sender_id)

```




```{r}
# which session is kagya active
all_sessions
```


#### Degree Distribution

```{r}

degree_stats <- degree(g, mode = "all")  
library(tidyverse)
network_stats_summary <- data.frame(
  id = V(g)$node_id,
  #name = V(g)$name,
  in_degree = degree(g, mode = "in"),
  out_degree = degree(g, mode = "out"),
  total_degree = degree(g, mode = "all"),
 hub_score = hub_score(g)$vector,
 authority_score = authority_score(g)$vector,
  eigenvector = eigen_centrality(g)$vector
) 



highlight <- function(df, color = "lightyellow", color2 = "lavender") {
  df %>%
    mutate(across(everything(), as.numeric)) %>% # Ensure numeric columns
    kable("html") %>%
    kable_styling("striped", full_width = F) %>%
    row_spec(which.max(df$total_degree), background = color) %>%
    row_spec(which.max(df$in_degree), background = color) %>%
    row_spec(which.max(df$out_degree), background = color) %>%
    row_spec(which.max(df$hub_score), background = color) %>%
    row_spec(which.max(df$authority_score), background = color) %>%
    row_spec(which.max(df$eigenvector), background = color) %>%
    row_spec(which.min(df$total_degree), background = color2) %>%
    row_spec(which.min(df$in_degree), background = color2) %>%
    row_spec(which.min(df$out_degree), background = color2) %>%
    row_spec(which.min(df$hub_score), background = color2) %>%
    row_spec(which.min(df$authority_score), background = color2) %>%
    row_spec(which.min(df$eigenvector), background = color2)
}

# Apply the function to highlight the maximum values
highlight(network_stats_summary)

```

-   **Degree**: This is the number of direct connections a node has.

    -   Ashley has the highest degree (473), or the greatest direct connections in the network.

-   **Closeness**: This measures how quickly a node can access all other nodes in the network. Higher values represent shorter paths to all other nodes.

    -   Ashley, with a closeness of 1.0000000, is the quickest to reach all other nodes.

Check for Isolates, Connectivity, and Directionality

```{r}

isolates <- which(degree(g) == 0)
if (length(isolates) > 0) {
  print(V(g)$name[isolates])
}


is.fully.connected <- is_connected(g)
print(is.fully.connected)


is.directed <- is_directed(g)
print(is.directed)

```



# REM Analysis

```{r, eval=FALSE}
interactions <- readRDS("data/all_sessions.RDS")
interactions$time<-as.numeric(interactions$time) 

# rmove 2103
interactions <- interactions %>% filter(session != 2103)
saveRDS(interactions, "data/all_sessionsno2103.RDS")
```


```{r, eval=FALSE}
readRDS("data/all_sessionsno2103.RDS") -> interactions
high <- interactions[interactions$performance == "high",]

# Create the REM data set
REM.data.high <- createRemDataset(
  data = high,
  sender = high$sender_id,
  target = high$receiver_id,
  eventSequence = high$time,
  eventAttribute = high$dialog,
  atEventTimesOnly = TRUE, 
  untilEventOccurrs = TRUE,
  includeAllPossibleEvents = FALSE, 
  returnInputData = FALSE
)
# save
saveRDS(REM.data.high, "data/REM.data.0505.high")

```


```{r, eval=FALSE}
low <- interactions[interactions$performance == "low",]
REM.data.low <- createRemDataset(
  data = low
  target = low$receiver_id,
  eventSequence = low$time,
  eventAttribute = low$dialog,
  atEventTimesOnly = TRUE, 
  untilEventOccurrs = TRUE,
  includeAllPossibleEvents = FALSE, 
  returnInputData = FALSE
)

saveRDS(REM.data.low, "data/REM.data.0505.low")


```

```{r, eval=TRUE}
readRDS("data/REM_data.RDS") -> REM.data
```

```{r}
# Check the structure of the REM.data
str(REM.data)
```

```{r}
head(REM.data)
```

```{r}

surv_object <- Surv(time = REM.data$eventTime, event = REM.data$eventDummy)


cox_model <- coxph(surv_object ~ sender + target, data = REM.data)


summary(cox_model)

```

```{r}

model2_event <- coxph(surv_object ~ eventAttribute, data = REM.data)
summary(model2_event)
```

```{r}

model3_snd_event <- coxph(surv_object ~ sender + eventAttribute, data = REM.data)
summary(model3_snd_event)
```

-   The `Concordance` statistic is a measure of the model's predictive ability, with 0.5 indicating no predictive ability and 1 indicating perfect prediction.

### Survival Analysis

-   How different factors (like senders, targets, event attributes) affect the likelihood of events:

-   `coef` in the model indicate the *logarithmic* change in hazard rates for different categories compared to a *baseline*. A positive coefficient indicates an increased hazard (or risk) of the event occurring when the variable increases, while a negative coefficient indicates a decreased hazard.

-   `exp(coef)` represents the *hazard ratio*, which explains the effect size. values greater than 1 indicate an increased hazard, values less than 1 indicate a decreased hazard.

-   The p-values (`Pr(>|z|)`) help determine the significance of the predictors.

## Result Analysis:

**Model 1: `sender` + `target`** as predictors

predictors are the sender and target IDs of the events.

-   **Senders 3, 4, 5, 6, and 7** have significant negative coefficients, suggesting that events sent by these individuals are less likely to occur compared to the baseline.
-   **Target 3 and 6** have significant negative coefficients, indicating events targeting these individuals are less likely to occur than the baseline target.
-   The p-values for the above mentioned actors are all below 0.05.
-   The overall model shows good predictive power with a concordance index of 0.606.

**Model 2: `eventAttribute`** as predictors

-   **`question` and `statement` types of dialog** have a positive and significant effect on the hazard, indicating these types of events are more likely to occur. Their coefficients are positive with low p-values (\< 2e-16 for `statement`, 4.63e-07 for `question`), showing strong evidence for their influence.
-   The `disruption` and `floor-grabber` types do not show a significant effect since their p-values are above 0.05.
-   The model has a concordance index of 0.641, indicating a reasonably good fit.

**Model 3: `sender` + `eventAttribute`** - senders and dialog types as predictors.

-   Similar to Model 1, **senders 3, 4, 5, 6, and 7** are significant predictors with negative coefficients, meaning events from these senders are less likely to happen compared to the reference sender.
-   As in Model 2, **`question` and `statement`** types of dialog are significant with positive coefficients, which means these event types are more likely to occur.
-   The coefficients for `disruption` and `floor-grabber` are not significant in this model as well
-   The concordance index is 0.665, the **highest** among the three models, suggesting this model has the best predictive ability.

### Summary

-   **Sender Effect**: Negative coefficients for all senders indicate they all decrease the event's hazard compared to a baseline, with `sender5` showing a significant reduction.
-   **Target Effect**: Similarly, most targets also reduce hazard rates, except `target4` and `target7` where the effect is not significant.
-   **Event Attributes** significantly increases the hazard of an event occurring.
    -   The `eventAttribute` variables have significant coefficients for `question` and `statement`, indicating that these attributes are associated with the occurrence of events.
    -   The hazard ratio of `statement` is about 4.41, suggesting its strong association with the occurrence of events...Is the effect of "statement" on event occurrences is genuinely significant, or is it inflated by the volume?
    -   `question` turns out to be important!
